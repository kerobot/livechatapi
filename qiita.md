# ã€React + FastAPIã€‘YouTube Live Chat ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã™ã‚‹Webã‚¢ãƒ—ãƒªã‚’ä½œã£ãŸğŸ¬ğŸ’¬

## ã¯ã˜ã‚ã«

è¶£å‘³ä½œæ¥­ä¸­ã¯é…ä¿¡ã‚’è¦–è´ã—ãªãŒã‚‰ãŒå¤šã„ã®ã§ã™ãŒã€ãµã¨ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚’è¦‹ãŸã¨ãã« Youtube ã®ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆæ¬„ãŒè¦‹ã¥ã‚‰ã„ãªã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚
ãã“ã§ã€YouTube ã®ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ Web ãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤ºã™ã‚‹ã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

æ§‹æˆã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒPython + FastAPIã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒTypeScript + Reactã¨ã„ã†ã€ã„ã¾ã©ããªæ„Ÿã˜ã«ã—ã¦ã„ã¾ã™ã€‚

## ã¤ãã£ãŸã‚‚ã®

- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: [kerobot/livechatapi](https://github.com/kerobot/livechatapi)
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: [kerobot/livechatviwer](https://github.com/kerobot/livechatviwer)


ï¼ˆå®Ÿéš›ã®å‹•ä½œç”»é¢ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼‰


## ä¸»ãªæ©Ÿèƒ½
- YouTubeå‹•ç”»IDã‚’å…¥åŠ›ã—ã¦ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆå–å¾—  
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º  
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ãƒ»ãƒãƒƒã‚¸è¡¨ç¤º  
- è‡ªå‹•ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆAPIãŒæ¨å¥¨ã™ã‚‹é–“éš”ã§æ›´æ–°ï¼‰  
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°  

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆlivechatapiï¼‰ã®æŠ€è¡“ãƒ»å®Ÿè£…

### æ¡ç”¨æŠ€è¡“
- Python 3
- FastAPI
- éåŒæœŸå‡¦ç†ï¼ˆasync/awaitï¼‰
- YouTube Data API

### å®Ÿè£…ã®ç‰¹å¾´
- FastAPI ã§ API ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã¦ã€YouTube Data APIã‹ã‚‰ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®šæœŸçš„ã«å–å¾—ã—ã¦ã¾ã™ã€‚
- éåŒæœŸã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹ã“ã¨ã§ã€è¤‡æ•°ãƒ©ã‚¤ãƒ–ã‚„å¤§é‡ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ã‚µã‚¯ã‚µã‚¯æŒã‘ã¾ã™ã€‚
- ãƒãƒ£ãƒƒãƒˆå–å¾—ã¯ä¸€å®šé–“éš”ã§ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦ã¾ã™ã€‚WebSocketã¯ä»Šå¾Œå¯¾å¿œã—ãŸã„ã§ã™ã€‚
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯JSONã§ã€ãƒ•ãƒ­ãƒ³ãƒˆå´ãŒæ‰±ã„ã‚„ã™ã„ã‚ˆã†ã«æ•´å½¢ã—ã¦ã¾ã™ã€‚
- ã‚·ãƒ³ãƒ—ãƒ«è¨­è¨ˆãªã®ã§ã€ä»–ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒãƒ£ãƒƒãƒˆAPIã¨ã‹ã«ã‚‚å¿œç”¨ã—ã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œHTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…

```python
import time
import random
import requests
from typing import Optional, Dict, Any
from app.config import ENVIRONMENT
import logging

logger = logging.getLogger(__name__)


class RateLimitedHTTPClient:
    """ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œã®HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ"""

    def __init__(self, max_retries: int = 3, base_delay: float = 1.0):
        self.max_retries = max_retries
        self.base_delay = base_delay
        self.session = requests.Session()

        # ç’°å¢ƒåˆ¥User-Agentè¨­å®š
        user_agent = f"LiveChatAPI/1.0 ({ENVIRONMENT})"
        if ENVIRONMENT == "production":
            user_agent += " (Production)"

        self.session.headers.update({"User-Agent": user_agent})

    def get_with_retry(self, url: str, params: Optional[Dict] = None) -> Dict[Any, Any]:
        """æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã¨ã‚¸ãƒƒã‚¿ãƒ¼ã‚’ä½¿ã£ãŸãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãGET"""
        for attempt in range(self.max_retries + 1):
            try:
                # ç’°å¢ƒåˆ¥ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
                timeout = 30 if ENVIRONMENT == "production" else 10
                response = self.session.get(url, params=params, timeout=timeout)

                # ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
                if response.status_code == 429:
                    if attempt == self.max_retries:
                        raise Exception("Rate limit exceeded after all retries")

                    retry_after = response.headers.get("Retry-After")
                    if retry_after:
                        delay = int(retry_after)
                    else:
                        delay = self.base_delay * (2**attempt) + random.uniform(0, 1)

                    logger.warning(
                        f"Rate limited. Retrying in {delay:.2f} seconds... (attempt {attempt + 1})"
                    )
                    time.sleep(delay)
                    continue

                response.raise_for_status()
                data = response.json()

                # YouTube APIã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if "error" in data:
                    error = data["error"]
                    if (
                        error.get("code") == 403
                        and "quota" in error.get("message", "").lower()
                    ):
                        raise Exception("YouTube API quota exceeded")
                    raise Exception(f"YouTube API Error: {error.get('message')}")

                logger.debug(f"Request successful: {url}")
                return data

            except requests.RequestException as e:
                if attempt == self.max_retries:
                    raise Exception(
                        f"Request failed after {self.max_retries} retries: {e}"
                    )

                delay = self.base_delay * (2**attempt) + random.uniform(0, 1)
                logger.warning(
                    f"Request failed (attempt {attempt + 1}). Retrying in {delay:.2f} seconds..."
                )
                time.sleep(delay)

        raise Exception("Unexpected error in retry logic")

    def close(self):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹"""
        self.session.close()
```

YouTube Data APIã®ã‚ˆã†ãªå¤–éƒ¨APIã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã¸ã®å¯¾å¿œãŒå¿…è¦ã¨ãªã‚‹ãŸã‚ã€ä»Šå›ã®å®Ÿè£…ã§ã¯ã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã¨ã‚¸ãƒƒã‚¿ãƒ¼ã‚’çµ„ã¿åˆã‚ã›ãŸå …ç‰¢ãªHTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚

### ç’°å¢ƒé©å¿œå‹ã®åˆæœŸåŒ–å‡¦ç†

```python
user_agent = f"LiveChatAPI/1.0 ({ENVIRONMENT})"
if ENVIRONMENT == "production":
    user_agent += " (Production)"
```

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–æ™‚ã«ç’°å¢ƒå¤‰æ•°ã«å¿œã˜ã¦User-Agentã‚’å‹•çš„ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€APIæä¾›å´ã§ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®åˆ†æã‚„å•é¡Œã®åˆ‡ã‚Šåˆ†ã‘ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚
æœ¬ç•ªç’°å¢ƒã§ã¯æ˜ç¤ºçš„ã«"Production"ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒã¨ã®åŒºåˆ¥ã‚’æ˜ç¢ºã«ã—ã¦ã„ã¾ã™ã€‚

### é«˜åº¦ãªãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥

HTTP 429ï¼ˆToo Many Requestsï¼‰ã‚¨ãƒ©ãƒ¼ã«å¯¾ã™ã‚‹å‡¦ç†ã¯ç‰¹ã«é‡è¦ãªã®ã§ã€ã‚µãƒ¼ãƒãƒ¼ãŒ`Retry-After`ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æä¾›ã™ã‚‹å ´åˆã¯ãã®å€¤ã«å¾“ã„ã€ãã†ã§ãªã„å ´åˆã¯æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•`base_delay * (2**attempt)`ã«ã‚¸ãƒƒã‚¿ãƒ¼`random.uniform(0, 1)`ã‚’åŠ ç®—ã—ã¦ã„ã¾ã™ã€‚

```python
if retry_after:
    delay = int(retry_after)
else:
    delay = self.base_delay * (2**attempt) + random.uniform(0, 1)
```

ã‚¸ãƒƒã‚¿ãƒ¼ã®å°å…¥ã«ã‚ˆã‚Šã€è¤‡æ•°ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåŒæ™‚ã«ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹éš›ã®ã€Œã‚µãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒãƒ¼ãƒ‰å•é¡Œã€ã‚’å›é¿ã§ãã¾ã™ã€‚ã“ã‚Œã¯å¤§è¦æ¨¡ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ç‰¹ã«é‡è¦ãªè€ƒæ…®ç‚¹ã§ã™ã­ã€‚

### YouTube APIå›ºæœ‰ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

YouTube APIã¯HTTP 200ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã«ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å«ã‚€å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ç‰¹ã«ã‚¯ã‚©ãƒ¼ã‚¿åˆ¶é™ï¼ˆ403ã‚¨ãƒ©ãƒ¼ï¼‰ã®æ¤œå‡ºã¯å®Ÿé‹ç”¨ã«ãŠã„ã¦å¿…é ˆã®æ©Ÿèƒ½ã ã¨æ€ã„ã¾ã™ã€‚

```python
if "error" in data:
    error = data["error"]
    if error.get("code") == 403 and "quota" in error.get("message", "").lower():
        raise Exception("YouTube API quota exceeded")
```

ã“ã®ã‚ˆã†ãªå¤šå±¤çš„ãªã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚Šã€APIå›ºæœ‰ã®æŒ™å‹•ã«ã‚‚é©åˆ‡ã«å¯¾å¿œã§ãã¾ã™ã€‚

### ç’°å¢ƒåˆ¥è¨­å®šã®æœ€é©åŒ–

é–‹ç™ºç’°å¢ƒã§ã¯è¿…é€Ÿãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é‡è¦–ã—ã¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’10ç§’ã«ã€æœ¬ç•ªç’°å¢ƒã§ã¯å®‰å®šæ€§ã‚’å„ªå…ˆã—ã¦30ç§’ã«è¨­å®šã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é–‹ç™ºåŠ¹ç‡ã¨æœ¬ç•ªå®‰å®šæ€§ã®ä¸¡ç«‹ã‚’å›³ã£ã¦ã„ã¾ã™ã€‚

```python
timeout = 30 if ENVIRONMENT == "production" else 10
```

ã“ã®HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€å¤–éƒ¨APIé€£æºã«ãŠã‘ã‚‹ä¸€èˆ¬çš„ãªèª²é¡Œã‚’åŒ…æ‹¬çš„ã«è§£æ±ºã™ã‚‹å®Ÿè£…ä¾‹ã¨ã—ã¦ã€ä»–ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚æ´»ç”¨ã§ãã‚‹æ±ç”¨æ€§ã®é«˜ã„è¨­è¨ˆã‚’ç›®æ¨™ã¨ã—ã¾ã—ãŸã€‚

### YouTubeService ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…è©³ç´°

``` python
import time
from typing import Optional
from app.models.youtube import LiveChatMessageListResponse
from app.config import (
    YOUTUBE_API_KEY,
    RATE_LIMIT_MAX_RETRIES,
    RATE_LIMIT_BASE_DELAY,
    RATE_LIMIT_REQUESTS_PER_SECOND,
)
from app.utils.http_client import RateLimitedHTTPClient
import logging

logger = logging.getLogger(__name__)


class YouTubeService:
    def __init__(self):
        self.client = RateLimitedHTTPClient(
            max_retries=RATE_LIMIT_MAX_RETRIES,
            base_delay=RATE_LIMIT_BASE_DELAY,
        )
        self.last_request_time = 0
        self.min_interval = 1.0 / RATE_LIMIT_REQUESTS_PER_SECOND
        logger.info("ğŸ¬ YouTubeService initialized")

    def _wait_for_rate_limit(self):
        """ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ã‚’åˆ¶å¾¡"""
        elapsed = time.time() - self.last_request_time
        if elapsed < self.min_interval:
            wait_time = self.min_interval - elapsed
            logger.debug(f"â±ï¸ Rate limiting: waiting {wait_time:.2f} seconds")
            time.sleep(wait_time)
        self.last_request_time = time.time()

    def get_live_chat_id(self, video_id: str) -> Optional[str]:
        """ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆIDã‚’å–å¾—"""
        logger.debug(f"ğŸ” Fetching live chat ID for video: {video_id}")
        self._wait_for_rate_limit()

        url = "https://www.googleapis.com/youtube/v3/videos"
        params = {
            "part": "liveStreamingDetails",
            "id": video_id,
            "key": YOUTUBE_API_KEY,
        }

        try:
            data = self.client.get_with_retry(url, params)
            items = data.get("items", [])

            if not items:
                logger.warning(f"ğŸš« No video found for ID: {video_id}")
                return None

            live_details = items[0].get("liveStreamingDetails", {})
            chat_id = live_details.get("activeLiveChatId")

            if chat_id:
                logger.info(f"âœ… Live chat ID retrieved: {chat_id} (video: {video_id})")
            else:
                logger.warning(f"âŒ No active live chat for video: {video_id}")

            return chat_id

        except Exception as e:
            logger.error(f"ğŸ’¥ Failed to get live chat ID for video {video_id}: {e}")
            raise

    def get_chat_messages(
        self, live_chat_id: str, page_token: Optional[str] = None
    ) -> LiveChatMessageListResponse:
        """ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—"""
        logger.debug(
            f"ğŸ’¬ Fetching messages for chat: {live_chat_id}, page_token: {page_token}"
        )
        self._wait_for_rate_limit()

        url = "https://www.googleapis.com/youtube/v3/liveChat/messages"
        params = {
            "liveChatId": live_chat_id,
            "part": "snippet,authorDetails",
            "key": YOUTUBE_API_KEY,
        }

        if page_token:
            params["pageToken"] = page_token

        try:
            data = self.client.get_with_retry(url, params)
            response = LiveChatMessageListResponse.model_validate(data)

            message_count = len(response.items) if hasattr(response, "items") else 0
            logger.info(
                f"ğŸ“¨ Retrieved {message_count} chat messages (chat: {live_chat_id})"
            )

            return response

        except Exception as e:
            logger.error(f"ğŸ’¥ Failed to get chat messages for {live_chat_id}: {e}")
            raise


# ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
youtube_service = YouTubeService()
```

ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯2æ®µéšã®APIå‘¼ã³å‡ºã—ã«ã‚ˆã£ã¦ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€é©åˆ‡ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### åˆæœŸåŒ–ã¨ãƒ¬ãƒ¼ãƒˆåˆ¶é™åˆ¶å¾¡

```python
def __init__(self):
    self.client = RateLimitedHTTPClient(
        max_retries=RATE_LIMIT_MAX_RETRIES,
        base_delay=RATE_LIMIT_BASE_DELAY,
    )
    self.last_request_time = 0
    self.min_interval = 1.0 / RATE_LIMIT_REQUESTS_PER_SECOND
```

ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ã¯ã€å…ˆè¿°ã®RateLimitedHTTPClientã‚’çµ„ã¿è¾¼ã¿ã€ã•ã‚‰ã«ç‹¬è‡ªã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚`min_interval`ã¯è¨­å®šå€¤ã‹ã‚‰å‹•çš„ã«è¨ˆç®—ã•ã‚Œã€1ç§’ã‚ãŸã‚Šã®æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€äºŒé‡ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ä¿è­·ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

### ç²¾å¯†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”åˆ¶å¾¡

```python
def _wait_for_rate_limit(self):
    elapsed = time.time() - self.last_request_time
    if elapsed < self.min_interval:
        wait_time = self.min_interval - elapsed
        logger.debug(f"â±ï¸ Rate limiting: waiting {wait_time:.2f} seconds")
        time.sleep(wait_time)
    self.last_request_time = time.time()
```

`_wait_for_rate_limit`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€å‰å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ã—ã€æœ€å°é–“éš”ã«é”ã—ã¦ã„ãªã„å ´åˆã¯é©åˆ‡ãªæ™‚é–“ã ã‘å¾…æ©Ÿã—ã¾ã™ã€‚ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€è¨­å®šã•ã‚ŒãŸãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å³å¯†ã«éµå®ˆã§ãã¾ã™ã€‚

### 2æ®µéšã®ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆå–å¾—ãƒ—ãƒ­ã‚»ã‚¹

YouTube APIã§ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹ã«ã¯ã€ã¾ãšå‹•ç”»IDã‹ã‚‰ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆIDã‚’å–å¾—ã—ã€ãã®å¾Œå®Ÿéš›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```python
def get_live_chat_id(self, video_id: str) -> Optional[str]:
    url = "https://www.googleapis.com/youtube/v3/videos"
    params = {
        "part": "liveStreamingDetails",
        "id": video_id,
        "key": YOUTUBE_API_KEY,
    }
```

`get_live_chat_id`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€å‹•ç”»ã®`liveStreamingDetails`ã‹ã‚‰`activeLiveChatId`ã‚’æŠ½å‡ºã—ã¾ã™ã€‚ã“ã®å€¤ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€ãã®å‹•ç”»ãŒãƒ©ã‚¤ãƒ–é…ä¿¡ã§ã¯ãªã„ã‹ã€ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

### Pydanticã«ã‚ˆã‚‹å‹å®‰å…¨ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†

```python
data = self.client.get_with_retry(url, params)
response = LiveChatMessageListResponse.model_validate(data)
```

å®Ÿéš›ã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã§ã¯ã€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’Pydanticãƒ¢ãƒ‡ãƒ«ã§æ¤œè¨¼ãƒ»å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å®Ÿè¡Œæ™‚ã®å‹å®‰å…¨æ€§ã‚’ç¢ºä¿ã—ã€äºˆæœŸã—ãªã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ã‚’é˜²æ­¢ã§ãã¾ã™ã€‚

### è©³ç´°ãªãƒ­ã‚°è¨˜éŒ²ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§çµµæ–‡å­—ã‚’æ´»ç”¨ã—ãŸè¦–èªæ€§ã®é«˜ã„ãƒ­ã‚°ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é–‹ç™ºæ™‚ã®ãƒ‡ãƒãƒƒã‚°ã‚„æœ¬ç•ªç’°å¢ƒã§ã®ç›£è¦–ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

```python
logger.info(f"ğŸ“¨ Retrieved {message_count} chat messages (chat: {live_chat_id})")
```

ç‰¹ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—æ•°ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã™ã‚‹ã“ã¨ã§ã€APIã®åˆ©ç”¨çŠ¶æ³ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ç›£è¦–ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†

```python
youtube_service = YouTubeService()
```

ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®Ÿè£…ã•ã‚Œã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§å˜ä¸€ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…±æœ‰ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™çŠ¶æ…‹ã®ä¸€è²«æ€§ã‚’ä¿ã¡ã€ä¸è¦ãªHTTPã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã‚’é¿ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®å®Ÿè£…ã¯ã€YouTube APIã®ç‰¹æ€§ã‚’ç†è§£ã—ãŸä¸Šã§ã€å®Ÿç”¨çš„ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™å‡¦ç†ã¨å …ç‰¢ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’çµ„ã¿åˆã‚ã›ãŸã€æœ¬ç•ªç’°å¢ƒã§ã®åˆ©ç”¨ã«è€ãˆã†ã‚‹è¨­è¨ˆã‚’ç›®æ¨™ã¨ã—ã¾ã—ãŸã€‚

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆlivechatviwerï¼‰ã®æŠ€è¡“ãƒ»å®Ÿè£…

### æ¡ç”¨æŠ€è¡“
- TypeScript
- React
- axios
- CSSãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

### å®Ÿè£…ã®ç‰¹å¾´
- Reactã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåŒ–ã—ã¦ã€ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºéƒ¨åˆ†ã‚’ã„ã„æ„Ÿã˜ã«åˆ†é›¢ã—ã¦ã„ã¾ã™ã€‚
- TypeScriptã§å‹å®‰å…¨ã«å®Ÿè£…ã—ã¦ã‚‹ãŸã‚ã€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å¤‰æ›´ã«ã‚‚å¼·ã„ã§ã™ã€‚
- axiosã§APIã‹ã‚‰æœ€æ–°ãƒãƒ£ãƒƒãƒˆã‚’ãƒãƒ¼ãƒªãƒ³ã‚°å–å¾—ã—ã¦ã€ç”»é¢å´ã«å³åæ˜ ã§ãã¾ã™ã€‚
- ã‚³ãƒ¡ãƒ³ãƒˆã®è¡¨ç¤ºã¯CSSã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§ã‚’é«˜ã‚ã¾ã—ãŸã€‚
- ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã‚‚æ„è­˜ã—ã¦ã‚‹ãŸã‚ã€ã‚¹ãƒãƒ›ã‹ã‚‰ã§ã‚‚å¿«é©ã«é–²è¦§ã§ãã¾ã™ã€‚

### Reactãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…è©³ç´°

```typescript
import React, { useState, useEffect, useRef } from 'react';
import { ChatMessage, LiveChatMessageItem } from '../types/youtube';
import { extractVideoId, validateVideoId, fetchLiveChat, formatTimestamp } from '../utils/youtube';
import './LiveChat.css';

const LiveChat: React.FC = () => {
  const [videoUrl, setVideoUrl] = useState<string>('');
  const [videoId, setVideoId] = useState<string | null>(null);
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [isConnected, setIsConnected] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);
  const [pollingInterval, setPollingInterval] = useState<number>(5000);
  const [nextPageToken, setNextPageToken] = useState<string | undefined>(undefined);
  const [messageCount, setMessageCount] = useState<number>(0);

  const intervalRef = useRef<NodeJS.Timeout | null>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  // æ¥ç¶šå‡¦ç†
  const handleConnect = () => {
    const extractedVideoId = extractVideoId(videoUrl);
    
    if (!extractedVideoId) {
      setError('ç„¡åŠ¹ãªYouTube URLã ã‚ˆã€œï¼æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ã­â™ª');
      return;
    }

    if (!validateVideoId(extractedVideoId)) {
      setError('å‹•ç”»IDã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆã€œï¼');
      return;
    }
    
    setVideoId(extractedVideoId);
    setError(null);
    setMessages([]);
    setMessageCount(0);
    setNextPageToken(undefined);
    setIsConnected(true);
    
    // åˆå›å–å¾—
    fetchMessages(extractedVideoId);
    
    // å®šæœŸå–å¾—ã‚’é–‹å§‹
    intervalRef.current = setInterval(() => {
      fetchMessages(extractedVideoId, nextPageToken);
    }, pollingInterval);
  };

  // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
  const fetchMessages = async (id: string, pageToken?: string) => {
    try {
      const response = await fetchLiveChat(id, pageToken);
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
      const newChatMessages: ChatMessage[] = response.items.map((item: LiveChatMessageItem) => ({
        id: item.id,
        authorName: item.authorDetails.displayName,
        authorPhotoUrl: item.authorDetails.profileImageUrl,
        message: item.snippet.displayMessage,
        timestamp: item.snippet.publishedAt,
        authorChannelId: item.snippet.authorChannelId,
      }));

      // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’è¿½åŠ ï¼ˆé‡è¤‡æ’é™¤ï¼‰
      setMessages(prevMessages => {
        const existingIds = new Set(prevMessages.map(msg => msg.id));
        const uniqueNewMessages = newChatMessages.filter(msg => !existingIds.has(msg.id));
        const updatedMessages = [...prevMessages, ...uniqueNewMessages];
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’æ›´æ–°
        setMessageCount(updatedMessages.length);
        
        return updatedMessages;
      });
      
      // ãƒšãƒ¼ã‚¸ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’æ›´æ–°
      setNextPageToken(response.nextPageToken);
      if (response.pollingIntervalMillis && response.pollingIntervalMillis !== pollingInterval) {
        setPollingInterval(response.pollingIntervalMillis);
        
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’å†è¨­å®š
        if (intervalRef.current) {
          clearInterval(intervalRef.current);
          intervalRef.current = setInterval(() => {
            fetchMessages(id, response.nextPageToken);
          }, response.pollingIntervalMillis);
        }
      }
      
    } catch (err) {
      console.error('ãƒãƒ£ãƒƒãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      const errorMessage = err instanceof Error ? err.message : 'ãƒãƒ£ãƒƒãƒˆã®å–å¾—ã«å¤±æ•—ã—ãŸã‚ˆã€œğŸ˜¢';
      setError(errorMessage);
    }
  };

  // åˆ‡æ–­å‡¦ç†
  const handleDisconnect = () => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }
    setIsConnected(false);
    setVideoId(null);
    setMessages([]);
    setMessageCount(0);
    setNextPageToken(undefined);
    setError(null);
  };

  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  useEffect(() => {
    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
    };
  }, []);

  return (
    <div className="live-chat">
      <div className="live-chat-header">
        <h1>ğŸ¥ ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</h1>
        
        <div className="connection-controls">
          <input
            type="text"
            value={videoUrl}
            onChange={(e) => setVideoUrl(e.target.value)}
            placeholder="YouTube URLã‚’å…¥åŠ›ã—ã¦ã­ã€œâ™ª"
            className="url-input"
            disabled={isConnected}
          />
          
          {!isConnected ? (
            <button 
              onClick={handleConnect} 
              className="connect-btn"
              disabled={!videoUrl.trim()}
            >
              æ¥ç¶šã™ã‚‹ï¼
            </button>
          ) : (
            <button onClick={handleDisconnect} className="disconnect-btn">
              åˆ‡æ–­ã™ã‚‹
            </button>
          )}
        </div>
        
        {error && <div className="error-message">{error}</div>}
        
        {isConnected && videoId && (
          <div className="status">
            <span className="connected-indicator">ğŸŸ¢</span>
            <span className="status-text">å‹•ç”»ID: {videoId} ã«æ¥ç¶šä¸­...</span>
            <span className="message-count">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: {messageCount}</span>
            <span className="polling-info">æ›´æ–°é–“éš”: {pollingInterval / 1000}ç§’</span>
          </div>
        )}
      </div>

      <div className="chat-container">
        {messages.length === 0 && isConnected && !error && (
          <div className="no-messages">
            <div className="loading-spinner">â³</div>
            <p>ãƒãƒ£ãƒƒãƒˆã‚’å¾…ã£ã¦ã‚‹ã‚ˆã€œï¼</p>
          </div>
        )}
        
        {messages.map((message) => (
          <div key={message.id} className="chat-message">
            <img 
              src={message.authorPhotoUrl} 
              alt={message.authorName}
              className="author-avatar"
              onError={(e) => {
                // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’è¡¨ç¤º
                e.currentTarget.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNkZGQiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNiIgcj0iNiIgZmlsbD0iIzk5OSIvPgo8cGF0aCBkPSJNMTAgMzJjMC02IDYtMTAgMTAtMTBzMTAgNCAxMCAxMCIgZmlsbD0iIzk5OSIvPgo8L3N2Zz4K';
              }}
            />
            <div className="message-content">
              <div className="message-header">
                <span className="author-name">{message.authorName}</span>
                <span className="timestamp">{formatTimestamp(message.timestamp)}</span>
              </div>
              <div className="message-text">{message.message}</div>
            </div>
          </div>
        ))}
        
        <div ref={messagesEndRef} />
      </div>
    </div>
  );
};

export default LiveChat;
```

ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€URLå…¥åŠ›ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã¾ã§ä¸€é€£ã®æ©Ÿèƒ½ã‚’åŒ…æ‹¬çš„ã«æä¾›ã—ã¾ã™ã€‚

### çŠ¶æ…‹ç®¡ç†ã¨useRefæ´»ç”¨

```typescript
const [videoUrl, setVideoUrl] = useState<string>('');
const [messages, setMessages] = useState<ChatMessage[]>([]);
const [isConnected, setIsConnected] = useState<boolean>(false);
const [pollingInterval, setPollingInterval] = useState<number>(5000);

const intervalRef = useRef<NodeJS.Timeout | null>(null);
const messagesEndRef = useRef<HTMLDivElement>(null);
```

çŠ¶æ…‹ç®¡ç†ã§ã¯ã€æ¥ç¶šçŠ¶æ…‹ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã€ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ãªã©ã€ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã«å¿…è¦ãªè¦ç´ ã‚’é©åˆ‡ã«åˆ†é›¢ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«`useRef`ã‚’æ´»ç”¨ã—ã¦ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å‡¦ç†ã¨DOMè¦ç´ ã¸ã®å‚ç…§ã‚’ç®¡ç†ã—ã¦ã„ã‚‹ã¨ã“ã‚ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

### è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ã®å®Ÿè£…

```typescript
const scrollToBottom = () => {
  messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
};

useEffect(() => {
  scrollToBottom();
}, [messages]);
```

æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚Œã‚‹ãŸã³ã«è‡ªå‹•çš„ã«æœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚`scrollIntoView`ã®`smooth`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚Šã€è¦–è¦šçš„ã«è‡ªç„¶ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‹•ä½œã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

### å …ç‰¢ãªæ¥ç¶šå‡¦ç†ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
const handleConnect = () => {
  const extractedVideoId = extractVideoId(videoUrl);
  
  if (!extractedVideoId) {
    setError('ç„¡åŠ¹ãªYouTube URLã ã‚ˆã€œï¼æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ã­â™ª');
    return;
  }

  if (!validateVideoId(extractedVideoId)) {
    setError('å‹•ç”»IDã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆã€œï¼');
    return;
  }
```

YouTube URLã‹ã‚‰å‹•ç”»IDã‚’æŠ½å‡ºã—ã€è¤‡æ•°æ®µéšã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ã§ã€UXå‘ä¸Šã‚’å›³ã£ã¦ã„ã¾ã™ã€‚

### åŠ¹ç‡çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é‡è¤‡æ’é™¤

```typescript
setMessages(prevMessages => {
  const existingIds = new Set(prevMessages.map(msg => msg.id));
  const uniqueNewMessages = newChatMessages.filter(msg => !existingIds.has(msg.id));
  const updatedMessages = [...prevMessages, ...uniqueNewMessages];
  
  setMessageCount(updatedMessages.length);
  return updatedMessages;
});
```

`Set`ã‚’ä½¿ç”¨ã—ãŸåŠ¹ç‡çš„ãªé‡è¤‡æ’é™¤ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ã“ã®æ–¹æ³•ã«ã‚ˆã‚Šã€O(n)ã®è¨ˆç®—é‡ã§æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¢ºä¿ã—ã¦ã„ã¾ã™ã€‚

### å‹•çš„ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”èª¿æ•´

```typescript
if (response.pollingIntervalMillis && response.pollingIntervalMillis !== pollingInterval) {
  setPollingInterval(response.pollingIntervalMillis);
  
  if (intervalRef.current) {
    clearInterval(intervalRef.current);
    intervalRef.current = setInterval(() => {
      fetchMessages(id, response.nextPageToken);
    }, response.pollingIntervalMillis);
  }
}
```

YouTube APIã‹ã‚‰è¿”ã•ã‚Œã‚‹ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã«å‹•çš„ã«å¯¾å¿œã™ã‚‹ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚é–“éš”ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯æ—¢å­˜ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã€æ–°ã—ã„é–“éš”ã§å†è¨­å®šã™ã‚‹ã“ã¨ã§ã€APIæ¨å¥¨å€¤ã‚’å³å¯†ã«éµå®ˆã—ã¦ã„ã¾ã™ã€‚

### ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒå‡¦ç†

```typescript
onError={(e) => {
  e.currentTarget.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNkZGQiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNiIgcj0iNiIgZmlsbD0iIzk5OSIvPgo8cGF0aCBkPSJNMTAgMzJjMC02IDYtMTAgMTAtMTBzMTAgNCAxMCAxMCIgZmlsbD0iIzk5OSIvPgo8L3N2Zz4K';
}}
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå ´åˆã€Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸSVGã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œã‚„ç”»åƒURLã®ç„¡åŠ¹åŒ–ã«å¯¾ã—ã¦é©åˆ‡ã«å¯¾å¿œã§ãã¾ã™ã€‚

### ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```typescript
useEffect(() => {
  return () => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
    }
  };
}, []);
```

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ã«é©åˆ‡ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²æ­¢ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯é•·æ™‚é–“å‹•ä½œã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ç‰¹ã«é‡è¦ãªå®Ÿè£…ã§ã™ã€‚
